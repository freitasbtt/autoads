PLANO DE FASES — APP DE CAMPANHAS (Multi-tenant, n8n, Meta Ads)
Versão: 1.0
Idioma: pt-BR

OBJETIVO
- Capacitar qualquer usuário a subir campanhas e acompanhar resultados do Meta Ads, com login multi-tenant, RBAC, formulários que disparam automações no n8n, painel de público-alvo e dashboard.
- Este documento lista as FASES DE CONSTRUÇÃO e CRITÉRIOS DE ACEITE.
- Inclui ONBOARDING GUIADO (Meta, WhatsApp, Drive) pronto para implementação.

ARQUITETURA (resumo)
- Clean Architecture + DDD leve (Domínio, Aplicação, Infra, UI).
- Postgres com RLS (tenant_id) + RBAC (Owner, Editor, Básico).
- APIs REST (OpenAPI 3.1), idempotência (X-Idempotency-Key), webhooks.
- Integração event-driven com n8n (webhook → callback).
- Observabilidade (logs estruturados, métricas, tracing).

FASE 0 — ONBOARDING GUIADO (IMPLEMENTAR JÁ)
Objetivo: Conectar e validar credenciais do tenant para Meta Ads, WhatsApp Cloud API e Google Drive.
Entregas:
  1) Wizard de 3 passos (UI):
     - Passo 1: Conectar Meta (OAuth ou token de sistema).
     - Passo 2: Conectar WhatsApp Business (phone_number_id, waba_id, token).
     - Passo 3: Conectar Google Drive (OAuth) e escolher drive_folder_id padrão.
  2) Endpoints (Backend):
     - POST /api/v1/onboarding/meta/connect
       Body: { auth_method: OAUTH|SYSTEM_USER, data:{...} }
     - POST /api/v1/onboarding/meta/test
       Ação: GET me, GET adaccounts, GET pages; salvar ad_account_id e page_id padrão.
     - POST /api/v1/onboarding/whatsapp/connect
       Body: { waba_id, whatsapp_number_id, access_token }
     - POST /api/v1/onboarding/whatsapp/test
       Ação: GET /v17.0/{whatsapp_number_id}?fields=verified_name; opcional: enviar mensagem para número de teste.
     - POST /api/v1/onboarding/drive/connect
       Body: { oauth_code }
     - POST /api/v1/onboarding/drive/test
       Ação: listar pasta; criar subpasta “Creatives” se não existir; salvar drive_folder_id padrão.
  3) Armazenamento seguro de credenciais por tenant (integrations.credentials_json com criptografia em repouso).
  4) Tela de “Status de Conexões” com check verde (ok), amarelo (parcial), vermelho (falta ação). Botão “Re-testar credenciais”.
  5) Logs e auditoria das conexões (sem expor segredos).
Critérios de Aceite:
  - Usuário conclui o wizard com 3 checks verdes.
  - Botão “Testar” retorna sucesso quando as APIs externas respondem 2xx e dados obrigatórios são retornados.
  - Em falha, mensagens específicas (ex.: token expirado, permissão ausente).

FASE 1 — BASE DA PLATAFORMA
Entregas:
  - Autenticação JWT + multitenancy (Postgres + RLS por tenant_id).
  - RBAC (Owner/Editor/Básico) aplicado nas rotas.
  - OpenAPI publicado (Swagger), healthcheck, logs estruturados, CI/CD básico.
Critérios de Aceite:
  - Isolamento total entre tenants verificado por testes de RLS.
  - Rotas protegidas por role; tentativas não autorizadas retornam 403.
  - Documentação coerente com respostas reais.

FASE 2 — FORMULÁRIO: SUBIR EM CAMPANHAS EXISTENTES + n8n
Entregas:
  - Endpoint POST /api/v1/forms/existing-campaigns/submit com pré-validações:
      Campos: page_id, instagram_user_id, whatsapp_number_id, drive_folder_id,
              message_text, title_text, leadgen_form_id, website_url, objectives[]
      Regras: se inclui LEAD → exigir leadgen_form_id; se inclui WHATSAPP → exigir whatsapp_number_id; se TRAFFIC → website_url.
  - Orquestração:
      UI → Backend: recebe e valida; cria automation_run (run_id).
      Backend → n8n: POST Webhook com run_id + HMAC.
      n8n → Backend: callback status COMPLETED|FAILED.
      Backend → UI: notificação; “mensagem de sucesso” quando COMPLETED.
Critérios de Aceite:
  - Envio sem campos obrigatórios falha com mensagem clara.
  - Completou no n8n → UI exibe sucesso; run rastreável por run_id.

FASE 3 — FORMULÁRIO: CRIAR NOVA CAMPANHA (TEMPLATE 3 AD SETS) + AGENDAMENTO
Entregas:
  - Endpoint POST /api/v1/forms/new-campaigns/submit
      Campos obrigatórios: campaign_name, objective (LEAD|TRAFFIC|WHATSAPP|CONVERSIONS|REACH),
                           budget_type (DAILY|LIFETIME), daily_budget,
                           start_time (ISO 8601), end_time (pode ser nulo),
                           creative{ message_text, title_text, drive_folder_id, website_url? },
                           strategy_template_id, audience_profile_id?.
      Regras de agendamento: aplicar start_time/end_time nos 3 Ad Sets; se end_time nulo → omitir (vitalícia).
      Objetivo REACH: optimization_goal=REACH; billing_event=IMPRESSIONS; detailed_targeting_expansion=false; targeting exclusivamente do audience_profile.
  - RBAC: Básico não pode alterar estratégia (apenas template padrão).
  - Orquestração n8n igual à Fase 2.
Critérios de Aceite:
  - Validações de data: start_time ≥ agora; end_time nulo ou ≥ start_time.
  - Payload no n8n contém 3 Ad Sets com horários propagados.
  - REACH cria campanha e ad sets com mapeamento correto.

FASE 4 — PAINEL DE PÚBLICO-ALVO
Entregas:
  - CRUD de audience_profiles (idade, interesses, comportamentos, custom list).
  - Upload CSV de clientes (hash PII antes de envio ao Meta).
  - Reutilização de perfis nos formulários.
Critérios de Aceite:
  - CSV inválido rejeitado com motivo.
  - Perfil salvo pode ser selecionado no form de criação.

FASE 5 — DASHBOARD + ABA CAMPANHAS
Entregas:
  - Conector de leitura Meta Ads; sincronização periódica de métricas em campaign_metrics.
  - Dashboard com KPIs (Spend, Leads, CPL, CTR) e tabela de campanhas (filtros).
  - Estado “conectar” quando não houver credenciais (integra com Fase 0).
Critérios de Aceite:
  - KPIs batem com amostras do Meta; filtros afetam cards/tabela.
  - Erros de credencial exibem CTA para refazer onboarding.

FASE 6 — API PÚBLICA DE EVENTOS + HARDENING
Entregas:
  - /api/v1/webhooks (cadastro) + emissão de automation.completed e error.occurred.
  - Rate limiting, idempotência, HMAC em webhooks, playbooks de erro.
  - Observabilidade (trace por run_id), testes E2E do fluxo completo.
Critérios de Aceite:
  - Retentativas com backoff quando 5xx/timeout.
  - Contratos OpenAPI com exemplos de sucesso/erro.

FASE 7 — POLIMENTO E ENTREGAS ADICIONAIS
Entregas (opcionais/plus):
  - Centro de notificações (in-app + email) com histórico.
  - Biblioteca de criativos (Drive) e variações de copy.
  - Agendamento de publicação e cap de orçamento por dia.
  - Exportações CSV para time de inside sales.
Critérios de Aceite:
  - NPS interno ≥ 8 para fluxo de criação e subida de campanha.
  - TTV (cadastro → 1ª campanha) abaixo de 15 minutos.

CHECKLIST TÉCNICO POR FASE (resumo)
- Segurança: tokens e segredos cifrados; least-privilege; rotação de tokens.
- Logs: correlacionar por run_id, tenant_id, user_id; não logar PII sensível.
- Testes: unit, integração, contract (OpenAPI), E2E principais.
- DX: Swagger atualizado, exemplos copy/paste, Postman/Insomnia collection.
- Observabilidade: painéis básicos (taxa de sucesso de automações, latência, erros).
- Feature flags: habilitar objetivos novos sem redeploy.

FIM
